<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Employee Dashboard</title>
<link rel="stylesheet" href="employee.css">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

  <!-- Navbar -->
  <div class="navbar">
    <button class="add-btn" onclick="openModal()">+ Add Residence</button>
    <a href="status.html" class="status-btn">Users status</a>
    <div id="notifWrapper">
      ðŸ”” <span id="notifCount">0</span>
    </div>
    <button class="logout-btn" onclick="logout()">Logout</button>

    <!-- Notification Popup -->
    <div id="notifPopup">
      <ul id="notifList"></ul>
    </div>
  </div>

  <!-- Notification Banner -->
  <div class="top-notif" id="topNotif"></div>

  <h1>Welcome, Employee</h1>
  <div id="usersDiv"></div>
  <!-- Modal -->
  <div class="modal" id="addModal">
    <div class="modal-content">
      <h3>Add Residence Account</h3>
      <form id="residenceForm">
        <input type="text" id="resUsername" placeholder="Username" required />
        <input type="password" id="resPassword" placeholder="Password" required />
        <input type="text" id="sensorRoot" placeholder="Sensor Root (e.g., sensorsX)" required />
        <button type="submit">Add Residence</button>
        <button type="button" class="close-btn" onclick="closeModal()">Cancel</button>
      </form>
    </div>
  </div>

  <div class="account-list" id="residenceList"></div>
    


  <!-- Chat Popup -->
  <div id="chatPopup" class="chat-popup">
    <div class="chat-header">
      <span id="chatWith">Chat</span>
      <button id="closeChat">Ã—</button>
    </div>
    <div id="chatMessages" class="chat-messages"></div>
    <form id="chatForm" class="chat-form">
      <input type="text" id="chatInput" placeholder="Type..." required />
      <button type="submit">Send</button>
    </form>
  </div>

<script>
  const app = firebase.initializeApp({
    databaseURL: "https://waterbase-b1393-default-rtdb.asia-southeast1.firebasedatabase.app/"
  });
  const db = firebase.database(app);

  // Modal
  function openModal() { document.getElementById("addModal").style.display = "flex"; }
  function closeModal() { document.getElementById("addModal").style.display = "none"; }

  // Add Residence
  document.getElementById("residenceForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    const username = document.getElementById("resUsername").value.trim();
    const password = document.getElementById("resPassword").value.trim();
    const root = document.getElementById("sensorRoot").value.trim();
    if (!username || !password || !root) return alert("All fields are required");

    const newUser = { username, password, role: "residence", sensorRoot: root };
    try {
      await db.ref("users").push(newUser);
      alert("Residence account added!");
      this.reset();
      closeModal();
      loadAllUserMeters();
    } catch (err) {
      alert("Error: " + err.message);
    }
  });

  // Chat state
  const username = "Employee";
  let activeChatId = null;
  let chatRef = null;

  const chatPopup = document.getElementById("chatPopup");
  const closeChat = document.getElementById("closeChat");
  const chatMessages = document.getElementById("chatMessages");
  const chatWith = document.getElementById("chatWith");
  const chatForm = document.getElementById("chatForm");
  const chatInput = document.getElementById("chatInput");
  const topNotif = document.getElementById("topNotif");

  closeChat.onclick = () => { chatPopup.style.display = "none"; if(chatRef) chatRef.off(); };

  chatForm.addEventListener("submit", e => {
    e.preventDefault();
    if (!activeChatId) return;
    const msg = chatInput.value.trim();
    if (!msg) return;
    chatRef.push({ sender: username, text: msg, timestamp: Date.now() });
    chatInput.value = "";
  });

  async function loadAllUserMeters() {
    const list = document.getElementById("residenceList");
    list.innerHTML = "";
    const snapshot = await db.ref("users").once("value");
    const users = snapshot.val() || {};

    for (const uid in users) {
      const user = users[uid];
      let sensorPath = null;

      if (user.role === "residence" && user.sensorRoot) {
        sensorPath = `${user.sensorRoot}/${uid}/water_timer_counter/value`;
      } else if (user.sensorPath) {
        sensorPath = user.sensorPath;
      }

      if (!sensorPath) continue;

      const card = document.createElement("div");
      card.className = "meter-card";
      card.innerHTML = `
        <div class="circle-meter">
          <div class="value">...</div>
          <div class="unit">Liters</div>
        </div>
        <div class="username">${user.username}</div>
        <div class="role">${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</div>
        <button class="notif-btn" onclick="toggleNotif('${uid}')">ðŸ”” Notify</button>
        <button class="notif-btn" onclick="openChat('${user.username}')">ðŸ’¬ Chat</button>
        <div class="notif-popup" id="notif-${uid}">
          <textarea placeholder="Enter message..."></textarea>
          <button onclick="sendNotif('${uid}')">Send</button>
          <button class="closeN" onclick="toggleNotif('${uid}')">Ã—</button>
        </div>
      `;

      list.appendChild(card);

      const valueEl = card.querySelector(".value");
      db.ref(sensorPath).on("value", (snap) => {
        const val = snap.val();
        valueEl.textContent = val !== null ? val : "0";
      }, () => {
        valueEl.textContent = "N/A";
      });
    }

    if (list.innerHTML === "") {
      list.innerHTML = "<p>No users with meters found.</p>";
    }
  }

  function toggleNotif(uid) {
    const popup = document.getElementById(`notif-${uid}`);
    popup.style.display = popup.style.display === "block" ? "none" : "block";
  }

  function sendNotif(uid) {
    const popup = document.getElementById(`notif-${uid}`);
    const textarea = popup.querySelector("textarea");
    const message = textarea.value.trim();
    if (!message) return alert("Message is empty!");
    alert("Notification sent to " + uid + ": " + message);
    textarea.value = "";
    popup.style.display = "none";
  }

  // Chat
  window.openChat = (resName) => {
    activeChatId = `${resName}_${username}`;
    chatWith.textContent = `Chat with ${resName}`;
    chatMessages.innerHTML = "";
    chatPopup.style.display = "flex";

    if(chatRef) chatRef.off();
    chatRef = db.ref("chats/" + activeChatId);
    chatRef.on("child_added", snap => {
      const msg = snap.val();
      const div = document.createElement("div");
      div.className = msg.sender === username ? "sent" : "received";
      div.textContent = msg.text;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      if (msg.sender !== username) showTopNotif(`New message from ${msg.sender}: ${msg.text}`);
    });
  };

  function showTopNotif(message) {
    topNotif.textContent = message;
    topNotif.style.display = "block";
    setTimeout(() => { topNotif.style.display = "none"; }, 4000);
  }

  function logout() {
    localStorage.clear();
    sessionStorage.clear();
    window.location.replace("index.html");
  }

  loadAllUserMeters();

  // ===== Notification Popup Code =====
  const notifWrapper = document.getElementById("notifWrapper");
  const notifCountEl = document.getElementById("notifCount");
  const notifPopup = document.getElementById("notifPopup");
  const notifList = document.getElementById("notifList");

  let notifications = [];

  function addNotification(message) {
    notifications.unshift(message); // newest first
    notifCountEl.textContent = notifications.length;
    notifCountEl.style.display = "inline-block";

    // Update popup list
    notifList.innerHTML = "";
    notifications.forEach(msg => {
      const li = document.createElement("li");
      li.textContent = msg;
      notifList.appendChild(li);
    });
  }

  notifWrapper.onclick = () => {
    notifPopup.style.display = notifPopup.style.display === "block" ? "none" : "block";
    notifCountEl.textContent = "0";
    notifCountEl.style.display = "none";
  };

  // Listen for Firebase messages to show in notification popup
  const chatsRefPopup = firebase.database().ref("chats");
  chatsRefPopup.on("child_added", snapshot => {
    const chatId = snapshot.key;
    const messagesRef = chatsRefPopup.child(chatId);

    messagesRef.on("child_added", msgSnap => {
      const msg = msgSnap.val();
      if (msg.sender !== username) addNotification(`New message from ${msg.sender}: ${msg.text}`);
    });
  });

  
  // Call renderNotifications on page load to ensure state is correctly updated
  renderNotifications();

  ////////////////////////////////////////////////////

  // Listen for Firebase new chat messages to add notifications
  const chatsRef = db.ref("chats");
  chatsRef.on("child_added", (chatSnapshot) => {
    const chatId = chatSnapshot.key;
    const messagesRef = chatsRef.child(chatId);

    messagesRef.on("child_added", (msgSnap) => {
      const msg = msgSnap.val();
      if (msg.sender !== username) {
        const notifText = `New message from ${msg.sender}: ${msg.text}`;
        addNotification(notifText);
        fireSystemNotification(`New message from ${msg.sender}`, msg.text);
      }
    });
  });

  // Browser notification with service worker
  async function fireSystemNotification(title, message) {
    if (!("Notification" in window)) return;
    if (Notification.permission === "granted") {
      const reg = await navigator.serviceWorker.getRegistration();
      if (reg) {
        reg.showNotification(title, {
          body: message,
          icon: "https://cdn-icons-png.flaticon.com/512/1827/1827392.png",
          vibrate: [100, 50, 100],
          tag: "chat-message",
          renotify: true,
        });
      }
    }
  }

  // Request notification permission if not granted
  if ("Notification" in window && Notification.permission !== "granted") {
    Notification.requestPermission();
  }

  // Register Service Worker
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker
      .register("sw.js")
      .then(reg => {
        console.log("Service Worker registered", reg.scope);
      })
      .catch(err => {
        console.error("Service Worker registration failed", err);
      });
  }

  // Initial load
  loadAllUserMeters();
  
</script>
</body>
</html>
